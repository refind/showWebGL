var scene3D=[],scene3DFunction=[];EmpScene=function(){this.name="empscene";this.scene=this.controls=this.camera=this.container=this.renderer=null;this.valid=!1;this.stats=this.grid=null;this.sceneBoundingBox=new THREE.Box3;this.sceneBoundingBox.makeEmpty();this.clearColor=3829413;this.clearAlpha=1;this.helpers={};this.selected=null;this.raycaster=new THREE.Raycaster;this.actived=!1;this.models=[]};EmpScene.prototype={constructor:EmpScene,setScene:function(a){this.scene.uuid=a.uuid;this.scene.name=a.name;for(this.scene.userData=JSON.parse(JSON.stringify(a.userData));0<a.children.length;)this.addObject(a.children[0])},select:function(a){this.selected!==a&&(this.selected=a)},selectById:function(a){a===this.camera.id?this.select(this.camera):this.select(this.scene.getObjectById(a,!0))},selectByUuid:function(a){var b=this;this.scene.traverse(function(c){c.uuid===a&&b.select(c)})},deselect:function(){this.select(null)},findObjectByName:function(a){if(!this.scene)return null;for(var b in this.scene.children){var c=this.scene.children[b];if(c.name==a)return c}return null},removeObjectByName:function(a){(a=this.findObjectByName(a))&&a.parent.remove(a)},addObject:function(a){this.findObjectByName(a.name)||this.scene.add(a)},addHelper:function(){var a=new THREE.SphereGeometry(20,4,2),b=new THREE.MeshBasicMaterial({color:16711680});return function(c){var d;if(c instanceof THREE.Camera)d=new THREE.CameraHelper(c,10);else if(c instanceof THREE.PointLight)d=new THREE.PointLightHelper(c,10);else if(c instanceof THREE.DirectionalLight)d=new THREE.DirectionalLightHelper(c,20);else if(c instanceof THREE.SpotLight)d=new THREE.SpotLightHelper(c,10);else if(c instanceof THREE.HemisphereLight)d=new THREE.HemisphereLightHelper(c,10);else if(c instanceof THREE.SkinnedMesh)d=new THREE.SkeletonHelper(c);else return;var e=new THREE.Mesh(a,b);e.name="picker";e.userData.object=c;e.visible=!1;d.add(e);this.sceneHelpers.add(d);this.helpers[c.id]=d}}(),findObjectByUUID:function(a){if(!this.scene)return null;for(var b in this.scene.children){var c=this.scene.children[b];if(c.uuid==a)return c}return null},setClearColor:function(a,b){this.clearColor=a;this.clearAlpha=b;this.renderer.setClearColor(this.clearColor,this.clearAlpha)},getObjs:function(){if(this.scene){for(var a in this.scene.children){var b=this.scene.children[a];"Mesh"==b.type?(this.models[b.uuid]=b,this.models[b.material.uuid]=b.material):this.models[b.uuid]=b}console.log(this.models);a=this.scene.toJSON();console.log(a)}},clearScene:function(){this.camera.position.set(500,250,500);this.camera.lookAt(new THREE.Vector3);for(var a=this.scene.children;0<a.length;)this.removeObject(a[0]);this.geometries={};this.materials={};this.textures={};this.scripts={};this.deselect()},removeHelper:function(a){if(void 0!==this.helpers[a.id]){var b=this.helpers[a.id];b.parent.remove(b);delete this.helpers[a.id]}},removeObject:function(a){if(void 0!==a.parent){var b=this;a.traverse(function(a){b.removeHelper(a)});a.parent.remove(a)}},initScene:function(a){function b(a){a.preventDefault();var b=new THREE.Vector2,f=!!a.touches,k=f?a.touches[0].pageX/EmpGlobalZoom-EmpGlobalLeft-a.currentTarget.offsetLeft:a.offsetX/EmpGlobalZoom,f=f?a.touches[0].pageY/EmpGlobalZoom-EmpGlobalTop-a.currentTarget.offsetTop:a.offsetY/EmpGlobalZoom,k=k/a.currentTarget.clientWidth,f=f/a.currentTarget.clientHeight;b.x=2*k-1;b.y=1-2*f;c.raycaster.setFromCamera(b,c.camera);b=c.raycaster.intersectObjects(c.scene.children);if(0<b.length&&(b=b[0].object)&&"Mesh"==b.type)if("mouseup"==a.type||"touchend"==a.type){if("function"==typeof scene3DFunction[b.name+"_up"])scene3DFunction[b.name+"_up"]()}else if(("mousedown"==a.type||"touchstart"==a.type)&&"function"==typeof scene3DFunction[b.name+"_down"])scene3DFunction[b.name+"_down"]()}this.valid=!1;this.container=document.getElementById(a);if(!this.container)return null;this.scene=new THREE.Scene;this.camera=new THREE.PerspectiveCamera(50,this.container.offsetWidth/this.container.offsetHeight,.1,1E4);this.controls=new THREE.TrackballControls(this.camera,this.container);isBuilderMode&&(this.controls.enabled=!1);this.createRender(!0);var c=this;this.container.addEventListener("mousedown",b,!1);this.container.addEventListener("mouseup",b,!1);this.container.addEventListener("touchstart",b,!1);this.container.addEventListener("touchend",b,!1)},createRender:function(a){a=new THREE.WebGLRenderer({antialias:a,alpha:!0});a.setClearColor(this.clearColor,this.clearAlpha);a.setPixelRatio(window.devicePixelRatio);a.autoClear=!1;a.autoUpdateScene=!1;a.setSize(this.container.offsetWidth,this.container.offsetHeight);this.container.appendChild(a.domElement);this.renderer=a},createStat:function(){var a=new Stats;a.domElement.style.position="absolute";a.domElement.style.top="0px";this.container.appendChild(a.domElement);this.stats=a},getMaterialByObjName:function(a){return(a=this.findObjectByName(a))&&"Mesh"==a.type?a.material:null},setMaterialByObjName:function(a,b){var c=this.findObjectByName(a);c?"Mesh"==c.type?c.material=b:console.log("obj not mesh",a):console.log("obj not found",a)},loadEmpObjs:function(a){var b=this,c=new THREE.JSONLoader;(new THREE.JSONIndexLoader).load(a,function(d){for(var e=0;e<d.guid.length;++e){var f=a.replace("index.js",d.guid[e]+".js");c.load(f,function(a,c,d){mesh1=new THREE.Mesh(a,c[0]);mesh1.name=a.name;mesh1.applyMatrix(d);a.computeBoundingBox();a=a.boundingBox;a.applyMatrix4(d);b.sceneBoundingBox.expandByPoint(a.min);b.sceneBoundingBox.expandByPoint(a.max);bbspere=b.sceneBoundingBox.getBoundingSphere();d=b.sceneBoundingBox.center();b.camera.lookAt(d);b.controls.target.copy(d);b.scene.add(mesh1)})}})},loadObjs:function(a,b,c,d){var e=this;a&&(new THREE.JSONLoader).load(a,function(a,k){var h=b;b||(h=k[0]);var g=h,h=new THREE.Vector3(0,0,0),l=new THREE.Vector3(0,0,0);a.computeVertexNormals();g.side=THREE.DoubleSide;g=new THREE.Mesh(a,g);g.name=c;g.scale.x=g.scale.y=g.scale.z=1;h&&g.position.copy(h);l&&g.rotation.copy(new THREE.Euler(l.x,l.y,l.z,"XYZ"));a.computeBoundingBox();a.computeBoundingSphere();e.addObject(g);h=a.boundingBox;g.updateMatrixWorld(!0);h.applyMatrix4(g.matrixWorld);e.sceneBoundingBox.expandByPoint(h.min);e.sceneBoundingBox.expandByPoint(h.max);d?d(g):e.updateCameraControl(e)})},updateCameraControl:function(a){if(!a.sceneBoundingBox.empty()){var b=a.sceneBoundingBox.getBoundingSphere().center;b.y=b.y;a.controls.target=b;a.controls.object.position.copy(new THREE.Vector3(50,1800,2E3));a.controls.object.up.copy(new THREE.Vector3(0,1,0));a.controls.rotateSpeed=1.5;a.controls.zoomSpeed=1.2;a.controls.panSpeed=1;a.controls.noZoom=!1;a.controls.noPan=!0;a.controls.staticMoving=!0;a.controls.dynamicDampingFactor=.3;a.controls.keys=[65,83,68];a.getObjs()}},switchCamera:function(a,b,c,d){this.controls.target=c;this.controls.object.position.copy(d);this.controls.object.up.copy(new THREE.Vector3(0,1,0))},switchToCameraAni:function(a,b,c){this.controls.object.up.copy(new THREE.Vector3(0,1,0));b&&(new TWEEN.Tween(this.controls.object.position)).to(b,c).easing(TWEEN.Easing.Exponential.InOut).start();a&&(new TWEEN.Tween(this.controls.target)).to(a,c).easing(TWEEN.Easing.Exponential.InOut).start()},switchToCameraMain:function(){var a=this.sceneBoundingBox.getBoundingSphere().center;this.controls.object.up.copy(new THREE.Vector3(0,1,0));this.emitLight(!1);TWEEN.removeAll();(new TWEEN.Tween(this.controls.object.position)).to({x:5191.1,y:2022.56,z:4316.52},2E3).easing(TWEEN.Easing.Exponential.InOut).start();(new TWEEN.Tween(this.controls.target)).to({x:a.x,y:a.y,z:a.z},2E3).easing(TWEEN.Easing.Exponential.InOut).start()},switchToCamera1:function(){var a=this.sceneBoundingBox.getBoundingSphere().center,b=this.sceneBoundingBox.size();a.x+=0*b.x;a.y+=.5*b.y;a.z+=-.14*b.z;this.controls.object.up.copy(new THREE.Vector3(0,1,0));TWEEN.removeAll();(new TWEEN.Tween(this.controls.object.position)).to({x:1810.57,y:1179.56,z:2666.52},2E3).easing(TWEEN.Easing.Exponential.InOut).start();(new TWEEN.Tween(this.controls.target)).to({x:a.x,y:a.y,z:a.z},2E3).easing(TWEEN.Easing.Exponential.InOut).start()},emitLight:function(a){if(a){a=empGetElementByID("353242553-2007828006-1563581018-2129400898","div",null);for(var b=1;6>b;++b){var c=empGetElementByID("1042967337-1343699393-1591084812-1325097130-"+b,"div",a);a.appendChild(c);c.style.cssText="pointer-events:none;border-radius:1024px; background-image:url('resources/red.png');background-size:100% 100%;background-repeat:no-repeat;position:absolute;left:339px;top:264px;width:119px;height:121px; opacity:0;transform-origin:50% 50% ;transform:rotate(0deg) skew(0deg,0deg); z-index:"+(120-b)+";";this.bindDomUI("1042967337-1343699393-1591084812-1325097130-"+b,new THREE.Vector3(-0,.45,-.14));$("#1042967337-1343699393-1591084812-1325097130-"+b).animo({animation:"fadeOutDownLRT",iterate:"infinite",delay:.5*(b-1),duration:2.5,keep:!1,timing:"ease-in"},function(){})}}else for(b=1;6>b;++b)empDeleteElementByID("1042967337-1343699393-1591084812-1325097130-"+b)},switchToCamera2:function(){var a=this.sceneBoundingBox.getBoundingSphere().center,b=this.sceneBoundingBox.size();a.x+=-.35*b.x;a.y+=-.02*b.y;a.z+=.35*b.z;this.controls.object.up.copy(new THREE.Vector3(0,1,0));TWEEN.removeAll();(new TWEEN.Tween(this.controls.object.position)).to({x:390.57,y:1354.56,z:752.52},2E3).easing(TWEEN.Easing.Exponential.InOut).start();(new TWEEN.Tween(this.controls.target)).to({x:a.x,y:a.y,z:a.z},2E3).easing(TWEEN.Easing.Exponential.InOut).start()},switchToCamera3:function(){var a=this.sceneBoundingBox.getBoundingSphere().center,b=this.sceneBoundingBox.size();a.x+=.32*b.x;a.y+=-.04*b.y;a.z+=.4*b.z;this.controls.object.up.copy(new THREE.Vector3(0,1,0));TWEEN.removeAll();(new TWEEN.Tween(this.controls.object.position)).to({x:26.57,y:1758.56,z:1451.52},2E3).easing(TWEEN.Easing.Exponential.InOut).start();(new TWEEN.Tween(this.controls.target)).to({x:537,y:1096,z:251},2E3).easing(TWEEN.Easing.Exponential.InOut).start()},bindDomUI:function(a,b){var c=this.sceneBoundingBox.getBoundingSphere().center,d=this.sceneBoundingBox.size();c.x+=b.x*d.x;c.y+=b.y*d.y;c.z+=b.z*d.z;c=c.project(this.camera);if(d=document.getElementById(a)){var e=(1-c.y)*this.container.offsetHeight/2+this.container.offsetTop-d.offsetHeight/2;d.style.left=((c.x+1)*this.container.offsetWidth/2+this.container.offsetLeft-d.offsetWidth/2).toFixed(0)+"px";d.style.top=e.toFixed(0)+"px"}},enable:function(){this.actived=!0;this.reszieScene();this.animate()},disable:function(){this.actived=!1},animate:function(){if(0!=this.actived){TWEEN.update();this.stats&&this.stats.update();if(this.controls){0==this.controls.screen.width&&0==this.controls.screen.height&&this.controls.handleResize();this.controls.object.up=new THREE.Vector3(0,1,0);var a=this.sceneBoundingBox.getBoundingSphere(),b=new THREE.Vector3;b.subVectors(this.controls.object.position,this.controls.target);b=b.length();1<b-a.radius&&(this.camera.near=b-a.radius);this.camera.far=b+a.radius+1;this.camera.updateProjectionMatrix();this.controls.update()}this.render();requestAnimationFrame(animateGlobal)}},render:function(){this.actived&&(this.scene.updateMatrixWorld(),this.renderer.clear(),this.renderer.render(this.scene,this.camera))},reszieScene:function(){this.controls.handleResize();this.camera.aspect=this.container.offsetWidth/this.container.offsetHeight;this.camera.updateProjectionMatrix();this.renderer.setSize(this.container.offsetWidth,this.container.offsetHeight);this.render()},setSceneSize:function(a,b){this.controls.handleResize();this.camera.aspect=a/b;this.camera.updateProjectionMatrix();this.renderer.setSize(a,b)}};function QueryCamInfo(a){var b="";if(a=scene3D[a]){var b=b+("\u76f8\u673a\u4f4d\u7f6e:"+a.camera.position.x.toFixed(2)+","+a.camera.position.y.toFixed(2)+","+a.camera.position.z.toFixed(2)),b=b+("\r\n\u76ee\u6807\u4f4d\u7f6e:"+a.controls.target.x.toFixed(2)+","+a.controls.target.y.toFixed(2)+","+a.controls.target.z.toFixed(2)),b=b+("\r\n\u6700\u5c0f\u8ddd\u79bb:"+a.controls.minDistance.toFixed(2)),b=b+("\r\n\u6700\u5927\u8ddd\u79bb:"+a.controls.maxDistance.toFixed(2)),c=new THREE.Vector3;c.subVectors(a.controls.object.position,a.controls.target);b+="\r\n\u5f53\u524d\u8ddd\u79bb:"+c.length().toFixed(2)}return b}function QueryMeshInfo(a){var b="";a=a.split(".");if(2!=a.length)return b;var c=scene3D[a[0]];c&&(a=c.findObjectByName(a[1]))&&(c=a.geometry,b+="\u9876\u70b9\u4e2a\u6570:"+c.vertices.length,b+="\r\n\u4e09\u89d2\u9762\u4e2a\u6570:"+c.faces.length,b+="\r\nUV\u901a\u9053\u6570:"+c.faceVertexUvs.length+"\u5c42",b+="\r\n\u5305\u56f4\u5706\u4e2d\u5fc3\u70b9:"+c.boundingSphere.center.x.toFixed(2)+","+c.boundingSphere.center.y.toFixed(2)+","+c.boundingSphere.center.z.toFixed(2)+", \u534a\u5f84"+c.boundingSphere.radius.toFixed(2),b+="\r\n\u5305\u56f4\u76d2:"+c.boundingBox.min.x.toFixed(2)+","+c.boundingBox.min.y.toFixed(2)+","+c.boundingBox.min.z.toFixed(2)+" ~ "+c.boundingBox.max.x.toFixed(2)+","+c.boundingBox.max.y.toFixed(2)+","+c.boundingBox.max.z.toFixed(2),a=a.matrix.elements,b+="\r\n\u77e9\u9635:\r\n  "+a[0]+","+a[1]+","+a[2]+","+a[3]+",\r\n  "+a[4]+","+a[5]+","+a[6]+","+a[7]+",\r\n  "+a[8]+","+a[9]+","+a[10]+","+a[11]+",\r\n  "+a[12]+","+a[13]+","+a[14]+","+a[15]);return b}function _local_replaceColon(a){return a.replace(/:/g,"%3A")}function EMPLyuQuery(a){var b="QueryInfo:";a=a.split(":");if(3!=a.length)return"";"QueryCamInfo"==a[0]?(b+=a[0]+":",b+=_local_replaceColon(QueryCamInfo(a[1])),b+=":"+a[2]):"QueryMeshInfo"==a[0]&&(b+=a[0]+":",b+=_local_replaceColon(QueryMeshInfo(a[1])),b+=":"+a[2]);"function"==typeof MsgBuilder&&MsgBuilder(b)}function dom3dReszie(){for(var a in scene3D)scene3D[a].actived&&scene3D[a].reszieScene()}window.addEventListener("resize",dom3dReszie,!1);function animateGlobal(){for(var a in scene3D)scene3D[a].actived&&scene3D[a].animate()}function create3dScene(a,b,c,d,e){var f=scene3D[a];null==f&&(f=new EmpScene,f.initScene(a),scene3D[a]=f);f.setSceneSize(b,c);f.setClearColor(d,e);return f};