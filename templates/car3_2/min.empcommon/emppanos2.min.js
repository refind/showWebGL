var EmpPanoramas=[],EmpPanorama={createNew:function(d,f,k,p){var a=!1;for(id in EmpPanoramas)id==d&&(empsysP=EmpPanoramas[id],a=!0);if(0==a)return this.createNew2(d,f,k,p);EmpPanoramas[d].modify(f,k,p);return EmpPanoramas[d]},createNew2:function(d,f,k,p){var a={};EmpPanoramas[d]=a;a.initEnd=!1;a.divid=d;a.images=f;a.fovdegree=k;a.usedevice=p;a.camera;a.scene;a.renderer;a.target=new THREE.Vector3;a.fatherDom=document.getElementById(d);var l=90,g=0,q=0,t=0,u,v,e=0,h=0,r=!1,m=a.fatherDom.clientWidth,n=a.fatherDom.clientHeight;initEmp2=function(){init();animate()};a.modify=function(b,c,f){a.initEnd=!1;a.camera.fov=c;b=[b.posx,b.negx,b.posy,b.negy,b.posz,b.negz];for(id in b)if(c=document.getElementById(d+id+"image"))c.src=b[id];onWindowResize();a.initEnd=!0};init=function(){a.initEnd=!1;a.camera=new THREE.PerspectiveCamera(k,m/n,1,1E3);a.scene=new THREE.Scene;console.log("new ",a);for(var b=[{url:f.posx,position:[-512,0,0],rotation:[0,Math.PI/2,0]},{url:f.negx,position:[512,0,0],rotation:[0,-Math.PI/2,0]},{url:f.posy,position:[0,512,0],rotation:[Math.PI/2,0,Math.PI]},{url:f.negy,position:[0,-512,0],rotation:[-Math.PI/2,0,Math.PI]},{url:f.posz,position:[0,0,512],rotation:[0,Math.PI,0]},{url:f.negz,position:[0,0,-512],rotation:[0,0,0]}],c=0,d=0;d<b.length;d++){var g=b[d],e=document.createElement("img");e.width=1028;e.src=g.url;e.id=a.divid+d+"image";var h=new THREE.CSS3DObject(e);h.position.fromArray(g.position);h.rotation.fromArray(g.rotation);a.scene.add(h);e.onload=function(){++c;a.renderer.render(a.scene,a.camera);onWindowResize()}}a.renderer=new THREE.CSS3DRenderer;a.renderer.setSize(m,n);a.fatherDom.appendChild(a.renderer.domElement);a.fatherDom.addEventListener("mousedown",onDocumentMouseDown,!1);a.fatherDom.addEventListener("mousewheel",onDocumentMouseWheel,!1);a.fatherDom.addEventListener("touchstart",onDocumentTouchStart,!1);a.fatherDom.addEventListener("touchmove",onDocumentTouchMove,!1);a.fatherDom.addEventListener("touchend ",onDocumentTouchEnd,!1);a.fatherDom.addEventListener("resize",onWindowResize,!1);jQuery(window).bind("load",function(){onWindowResize()});a.initEnd=!0};onWindowResize=function(){a.initEnd&&(m=a.fatherDom.clientWidth,n=a.fatherDom.clientHeight,a.camera.aspect=m/n,a.camera.updateProjectionMatrix(),a.renderer.setSize(m,n))};a.resize=function(){onWindowResize()};onDocumentMouseDown=function(b){a.initEnd&&(b.preventDefault(),document.addEventListener("mousemove",onDocumentMouseMove,!1),document.addEventListener("mouseup",onDocumentMouseUp,!1))};onDocumentMouseMove=function(b){if(a.initEnd){var c=b.movementY||b.mozMovementY||0;l-=.1*(b.movementX||b.mozMovementX||0);g+=.1*c}};onDocumentMouseUp=function(b){a.initEnd&&(document.removeEventListener("mousemove",onDocumentMouseMove),document.removeEventListener("mouseup",onDocumentMouseUp))};onDocumentMouseWheel=function(b){a.initEnd&&(a.camera.fov-=.05*b.wheelDeltaY,a.camera.updateProjectionMatrix())};onDocumentTouchStart=function(b){a.initEnd&&(b.preventDefault(),b=b.touches[0],u=b.screenX,v=b.screenY,h=e=0,r=!1)};onDocumentTouchEnd=function(b){a.initEnd&&(h=e=0,r=!1)};onDocumentTouchMove=function(b){if(a.initEnd)switch(b.preventDefault(),b.touches.length){case 1:if(0==r){var c=b.touches[0];l-=.1*(c.screenX-u);g+=.1*(c.screenY-v);u=c.screenX;v=c.screenY}break;case 2:r=!0,c=b.touches[0].pageX-b.touches[1].pageX,b=b.touches[0].pageY-b.touches[1].pageY,e=Math.sqrt(c*c+b*b)}};animate=function(){if(a.initEnd){requestAnimationFrame(animate);g=Math.max(-85,Math.min(85,g));q=THREE.Math.degToRad(90-g);t=THREE.Math.degToRad(l);a.target.x=Math.sin(q)*Math.cos(t);a.target.y=Math.cos(q);a.target.z=Math.sin(q)*Math.sin(t);a.camera.lookAt(a.target);0==h&&(h=e);var b=e-h;1E-4<Math.abs(b)&&(a.camera.fov-=1*b,90<a.camera.fov&&(a.camera.fov=90),45>a.camera.fov&&(a.camera.fov=45),a.camera.updateProjectionMatrix());h=e;a.renderer.render(a.scene,a.camera)}};initEmp2();return a}};